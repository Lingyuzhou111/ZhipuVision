# ZhipuVision插件功能说明

## 基础功能

ZhipuVision是一个适用于dow-859-ipad项目的AI识图插件，调用智谱官方API进行视觉推理,需要访问[ 智谱AI开放平台 ](https://www.bigmodel.cn/invite?icode=X2DxJtbSTtZrPmDGSjIgW%2Bnfet45IvM%2BqDogImfeLyI%3D)获取API密钥。

1. **z识图** - 识别和分析图片内容
2. **z反推** - 反推图片提示词
3. **z视频** - 根据视频URL分析视频内容
 
## 新增功能概述

在原有ZhipuVision插件基础上，新增了两个专业的图片分析功能：

1. **z运镜** - 图生视频运镜提示词生成
2. **z特效** - 视觉特效提示词生成

这两个功能使用专业的提示词模板，能够根据图片内容生成高质量的AI视频制作提示词。

## 功能详情

### 1. z运镜功能

**用途**: 分析图片并生成专业的图生视频运镜提示词

**触发指令**:
- `z运镜 [图片URL] [可选问题]` - 直接使用URL分析
- `z运镜 [你的问题]` - 然后发送图片进行分析
- `z运镜` - 然后发送图片，使用默认运镜提示词
- 引用聊天中的图片并回复 `z运镜 [你的问题]`

**特点**:
- 专业的电影摄影和视觉叙事经验
- 根据图片内容选择合适的运镜类型
- 生成自然流畅的镜头语言描述
- 支持多种运镜方式：推镜头、拉镜头、摇镜头、移镜头等

### 2. z特效功能

**用途**: 分析图片并生成专业的视觉特效提示词

**触发指令**:
- `z特效 [图片URL] [可选问题]` - 直接使用URL分析
- `z特效 [你的问题]` - 然后发送图片进行分析
- `z特效` - 然后发送图片，使用默认特效提示词
- 引用聊天中的图片并回复 `z特效 [你的问题]`

**特点**:
- 专业的动态视效设计能力
- 深度分析图片的视觉元素和氛围基调
- 生成富有创意和电影感的视觉特效描述
- 专注环境特效和氛围营造

## 技术实现

### 提示词文件

新功能使用两个专门的提示词文件：

1. **i2v_prompts.txt** - 运镜提示词模板
   - 包含专业的图生视频提示词专家角色定义
   - 提供详细的运镜选择策略和动态设计原则
   - 包含多种运镜示例和电影级特效运镜

2. **vfx_prompts.txt** - 特效提示词模板
   - 包含专业动态视效设计师角色定义
   - 提供创意设计和氛围匹配指导
   - 包含多种场景的特效创意示例

### 代码修改

主要修改了以下部分：

1. **初始化阶段** (`__init__`方法)
   - 添加了提示词文件加载逻辑
   - 新增了`_load_prompt_file`方法

2. **关键词处理** (`on_handle_context`方法)
   - 扩展了关键词匹配逻辑，支持`i2v_keyword`和`vfx_keyword`
   - 修改了提示词选择逻辑，根据功能类型选择对应的提示词模板

3. **图片处理** (`_handle_image_upload_while_waiting`方法)
   - 扩展了等待类型处理，支持`i2v`和`vfx`类型
   - 修改了提示词选择逻辑

4. **配置文件** (`config.json`)
   - 添加了新的触发关键词配置
   - 确保关键词映射一致性

5. **帮助文档** (`get_help_text`方法)
   - 更新了帮助文本，包含新功能的使用说明

## 使用方法

### 基本用法

1. **直接URL分析**:
   ```
   z运镜 https://example.com/image.jpg 生成电影感运镜
   z特效 https://example.com/image.jpg 添加粒子特效
   ```

2. **分步操作**:
   ```
   用户: z运镜 生成推镜头效果
   机器人: 请发送图片。
   已记录您的问题：'生成推镜头效果'
   
   用户: [发送图片]
   机器人: [返回运镜提示词]
   ```

3. **引用图片**:
   ```
   用户: [引用之前的图片] z特效 营造梦幻氛围
   机器人: [返回特效提示词]
   ```

### 高级用法

1. **自定义问题**:
   - 可以针对特定需求提出详细问题
   - 例如："生成适合科幻电影的运镜效果"
   - 例如："添加适合恐怖片的视觉特效"

2. **风格指导**:
   - 可以指定特定的视觉风格
   - 例如："生成日系动漫风格的运镜"
   - 例如："添加赛博朋克风格的特效"

## 配置说明

### 触发关键词配置

在`config.json`文件中，可以自定义触发关键词：

```json
{
    "trigger_keywords": {
        "i2v_keyword": ["z运镜", "运镜"],
        "vfx_keyword": ["z特效", "特效"]
    }
}
```

### 提示词模板自定义

可以编辑以下文件来自定义提示词模板：

- `i2v_prompts.txt` - 运镜提示词模板
- `vfx_prompts.txt` - 特效提示词模板

修改这些文件后，重启插件即可生效。

## 注意事项

1. **模型兼容性**: 当前功能与现有的图片分析功能使用相同的API模型
2. **文件大小限制**: 遵循原有的图片大小限制（默认10MB）
3. **错误处理**: 包含完整的错误处理和用户友好的提示信息
4. **超时处理**: 支持操作超时和取消功能

## 更新日志

- **v1.6**: 新增z运镜和z特效功能
  - 添加专业的运镜提示词生成功能
  - 添加专业的特效提示词生成功能
  - 支持动态读取提示词文件
  - 完善错误处理和用户提示

  - 更新帮助文档和使用说明 
